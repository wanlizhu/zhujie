#!/bin/bash
NVBRANCH="sw/dev/gpu_drv/dev_a"

function dist-install() {
    INSTALLER=$([ "$1" = "" ] && echo "$HOME/NVIDIA-BUILD/LAST_BUILD" || echo "$1")
    if [ ! -f "$INSTALLER" ]; then
        echo "Error: Installer is missing: $INSTALLER" > /dev/stderr
        return 1
    fi

    sudo chmod +x "$INSTALLER"

    echo "Install NVIDIA Drivers: $INSTALLER"
    who am i > /dev/null && (
        sudo systemctl isolate multi-user
        sudo "$INSTALLER" -sb
        sudo systemctl isolate graphical
    ) || (
    	echo "Error: You can only run NVIDIA installer through SSH" > /dev/stderr
        return 1
    )	
}

function nvidia-source-version() {
    echo `grep '^#define NV_VERSION_STRING' $P4ROOT/$NVBRANCH/drivers/common/inc/nvUnixVersion.h  | awk '{print $3}' | sed 's/"//g'`
}

function nvidia-version-installed() {
    if [ "$1" = "" ]; then
        echo "Usage: nvidia-version-installed <ARCH>" > /dev/stderr
        return 1
    fi

    ARCH="$1"
    ARCHNAME=$([ "$ARCH" = "amd64" ] && echo "x86_64" || echo "i386")
    SOFILE=$(ls /usr/lib/$ARCHNAME-linux-gnu/libnvidia-glcore.so* | head -n 1)
    POS=$([ "$ARCH" = "amd64" ] && echo "46" || echo "44")
    LEN=$(( ${#SOFILE} - POS ))
    VERSION="${SOFILE:$POS:$LEN}"

    if [ -f "/usr/lib/$ARCHNAME-linux-gnu/libnvidia-glvkspirv.so.$VERSION" ]; then
        echo "$VERSION"
    else
        echo "Error: Failed to parse NVIDIA version installed: $VERSION" > /dev/stderr
        return 1
    fi
}

function module-install() {
    if [ "$1" = "" -o "$2" = "" -o "$3" = "" ]; then
        echo "Usage: module-install [MODULE] [ARCH] [BUILD_TYPE]" > /dev/stderr
        return 1
    fi

    MODULE="$1" && shift
    ARCH="$1" && shift
    BUILD_TYPE="$1" && shift 
    FOLDER="Linux_"$ARCH"_$BUILD_TYPE"

    if [ "$(nvidia-source-version)" != "$(nvidia-version-installed $ARCH)" ]; then  
        echo "Error: \"Source Version [$(nvidia-source-version)]\" != \"Installed Version [$(nvidia-version-installed $ARCH)]\"" > /dev/stderr
        return 1
    fi

    echo "Install NVIDIA Module: $MODULE $ARCH $BUILD_TYPE"
    case "$MODULE" in
        opengl)
            FOLDER="Linux_"$ARCH"_$BUILD_TYPE"
            OUTDIR="$P4ROOT/$NVBRANCH/drivers/OpenGL/_out/$FOLDER"
            BASENAME="libnvidia-glcore.so"
            VERSION=$(nvidia-source-version)
            ARCHNAME=$([ "$ARCH" = "amd64" ] && echo "x86_64" || echo "i386")
            TARGETNAME="/usr/lib/$ARCHNAME-linux-gnu/$BASENAME.$VERSION"
            
            if [ -f "$TARGETNAME" -o -L "$TARGETNAME" ]; then
                if [ ! -f "$TARGETNAME.backup" ]; then
                    sudo mv "$TARGETNAME" "$TARGETNAME.backup"
                fi
                sudo cp -f "$OUTDIR/$BASENAME" "$TARGETNAME"
            else
                echo "Error: $TARGETNAME is missing" > /dev/stderr
                return 1
            fi

            echo "Backup & Update: $TARGETNAME"
        ;;

        *)
            echo "Error: Module \"$MODULE\" is not supported" > /dev/stderr
            return 1
        ;;
    esac 
}

function module-revert() {
    if [ "$1" = "" ]; then
        echo "Usage: module-revert [ARCH]" > /dev/stderr
        return 1
    fi

    ARCH="$1" && shift
    ARCHNAME=$([ "$ARCH" = "amd64" ] && echo "x86_64" || echo "i386")
    FOLDER="/usr/lib/$ARCHNAME-linux-gnu"

    for FILE in `ls $FOLDER/*.backup`; do
        sudo mv -f "$FILE" "${FILE%.*}"
        echo "Reverted: ${FILE%.*}"
    done
}

if [ "$1" = "" ]; then
    echo "Usage: nvidia-install [OPTIONS]"
    echo "  e.g. nvidia-install <INSTALLER_PATH>"
    echo "  e.g. nvidia-install <MODULE> <ARCH> <BUILD_TYPE>"
    echo "  e.g. nvidia-install <-r|--revert> <ARCH>"
    exit 1
fi

while [ -n "$1" ]; do
    case "$1" in
        opengl)
            shift
            module-install opengl $@
            break
        ;;

        -r|--revert)
            shift
            module-revert $@
            break
        ;;

        *)
            if [ -f "$1" -o -L "$1" ]; then
                dist-install "$1"
                break
            else
                echo "Error: NVIDIA installer is missing: $1" > /dev/stderr
                exit 1
            fi
        ;;
    esac
    shift
done

