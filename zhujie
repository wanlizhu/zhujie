#!/bin/bash

# System
export __GL_SYNC_TO_VBLANK=0
export PATH="$HOME:$HOME/bin:$HOME/.local/bin:$HOME/zhujie:$PATH"
export _1080P=1920x1080
export _1K=1280x1024
export _2K=2560x1440
export _4K=3840x2160
alias ll='ls -alhF'

if [[ -z $DISPLAY ]]; then
    export DISPLAY=:0
fi

# Add zhujie to PATH
which zhujie > /dev/null || (
    export PATH="$(dirname $0):$PATH"
)

# NVIDIA tools
export PATH="$HOME/NVIDIA_TOOLS:$PATH"
if [[ -d $HOME/NVIDIA_TOOLS ]]; then
    for SUBDIR in $(ls -F $HOME/NVIDIA_TOOLS | grep / | awk'{print substr($0, 1, length($0)-1)}'); do
        case $SUBDIR in
            PIC-V|PIC-G|flamegraph) 
                export PATH="$HOME/NVIDIA_TOOLS/$SUBDIR:$PATH" 
            ;;
            P4V)
                export PATH="$HOME/NVIDIA_TOOLS/P4V/bin:$PATH"
            ;;
            Nsight_Graphics)
                export PATH="$HOME/NVIDIA_TOOLS/Nsight_Graphics/host/linux-desktop-nomad-x64:$PATH"
            ;;
        esac
    done 
fi

# Perforce
case $(hostname) in
    nvidia-master) 
        export P4USER=wanliz
        export P4PASSWD=""
        export P4ROOT=$HOME/NVIDIA_SRC_P4SW
        export P4CLIENT=nvidia-src-zhujie 
        export P4PORT=p4proxy-zj.nvidia.com:2006
        export P4IGNORE=$HOME/NVIDIA_P4IGNORE
        export PATH="$P4ROOT/sw/misc/linux:$P4ROOT/sw/automation/dvs/dvsbuild:$P4ROOT/sw/pvt/dleone/bin:$PATH"
    ;;
    nvidia-wingman) 
        export P4USER=wanliz
        export P4PASSWD=""
        export P4ROOT=$HOME/NVIDIA_SRC_P4SW
        export P4CLIENT=nvidia-src-zhujie 
        export P4PORT=p4proxy-zj.nvidia.com:2006
        export P4IGNORE=$HOME/NVIDIA_P4IGNORE 
        export PATH="$P4ROOT/sw/misc/linux:$P4ROOT/sw/automation/dvs/dvsbuild:$P4ROOT/sw/pvt/dleone/bin:$PATH"
    ;;
esac

function on-user-cancel() {
    echo ""
    popd > /dev/null
    exit 0
}

function combine-file-lines() {
    INFILE=$1
    tr -d '\r' < "$INFILE" > /tmp/zhujie-combine-lines
    sed ':a;N;$!ba;s/\n/, /g' /tmp/zhujie-combine-lines | sed 's/\n$//g'
}

function get-active-display() {
    # if [[ -z $(ps aux | grep [X]org) ]]; then
    #     echo "Xorg is not running" > /dev/stderr
    #     read -p "Do you wanna run a fake display? (empty for Yes): " RSVP
    #     case $RSVP in
    #         yes|y|"")
    #             fake-display &
    #             echo "Sleep for 10 seconds waiting for fake display..."
    #             sleep 10
    #         ;;
    #         *) exit 1 ;;
    #     esac
    # fi

    if [[ -z $DISPLAY ]]; then
        if [[ -f /tmp/zhujie-active-display ]]; then
            export DISPLAY=$(cat /tmp/zhujie-active-display)
        else
            read -p "Name a DISPLAY to continue (empty for :0) " RSVP
            case $RSVP in
                "") export DISPLAY=:0 ;;
                *) export DISPLAY=$RSVP ;;
            esac
            echo $RSVP > /tmp/zhujie-active-display
        fi
    fi

    glxinfo 1> /dev/null 2> /dev/null || (
        echo "Error: can't open display $DISPLAY" > /dev/stderr
        exit 1
    )
}

function has-nvidia-gpu() { 
    [[ -n $(sudo lshw -class display | grep NVIDIA) ]] && echo 1 || echo 0
}

function has-amd-gpu() {
    [[ -n $(sudo lshw -class display | grep 'vendor: Advanced Micro Devices') ]] && echo 1 || echo 0
}

function has-intel-gpu() {
    [[ -n $(sudo lshw -class display | grep 'vendor: Intel') ]] && echo 1 || echo 0
}

function cpu() {
    # CPU Model Name
    echo -ne "CPU Model Name: " 
    lscpu | grep "Model name:" | awk -F "name:" '{print $2}' | awk '{$1=$1; print}'
    
    # lscpu --all --extended 
}

function gpu() {
    if [[ $(has-nvidia-gpu) == 1 ]]; then
        echo "NVIDIA GPU Attached"
        nvidia-smi-static
    elif [[ $(has-amd-gpu) == 1 ]]; then
        echo "AMD GPU Attached"
    elif [[ $(has-intel-gpu) == 1 ]]; then
        echo "Intel GPU Attached"
    fi
}

function nvidia-smi-static() {
    which nvidia-smi > /dev/null || (
        echo "Error: can't find nvidia-smi in PATH"
        exit 1
    )
    
    nvidia-smi --query | grep "Driver Version" | awk -F ":" '{print "NVIDIA Driver Version:" $2}'
    
    # NVIDIA RM Version 
    if [[ -f /proc/driver/nvidia/version ]]; then 
        cat /proc/driver/nvidia/version | head -n 1
    fi
    
    for INDEX in `seq 0 $(($GPU_COUNT-1))`; do
        if [[ $INDEX > 0 ]]; then
            echo ""
        fi
        
        nvidia-smi -L | awk -F '\(UUID:' '{print $1}' | awk  "NR==$(($INDEX+1)){ print; exit; }"
        nvidia-smi --query --id=$INDEX --display=UTILIZATION | grep "Gpu" | awk '{ print "GPU Usage: " $3 $4 }'
        nvidia-smi --query --id=$INDEX --display=POWER | grep "Current Power Limit" | awk '{ print "Current Power Limit: " $5 $6 }'
        nvidia-smi --query --id=$INDEX --display=MEMORY | grep "Total" | head -n1 | awk '{ print "Total VRAM: " $3 $4 }'
        nvidia-smi --query --id=$INDEX --display=CLOCK | grep "Graphics" | awk 'NR==4{ print "Max Graphics Clock: " $3 $4 }'
    done
}

function display() {
    # Monitor
    which xdpyinfo > /dev/null && (
        TMP=$(xdpyinfo 2> /dev/null | grep dimensions)
        echo "Monitor:" ${TMP#  dimensions:    }
    )
    
    if [[ -n `ls -A /tmp/.X11-unix` ]]; then
        echo -ne ".X11-unix: [" && (cd /tmp/.X11-unix && for x in $(ls); do echo -ne ":${x#X} "; done; echo "]")
    else
        echo ".X11-unix: [NULL]"
    fi
    
    echo "DISPLAY: $([[ -n $DISPLAY ]] && echo $DISPLAY || echo '[NULL]')"
}

function perf() {
    echo "GPU Usage, CPU Affinity, CPU Usage"
    
    CONTINUE=1
    while [[ $CONTINUE == 1 ]]; do
        case $1 in
            "") PID="" ;;
            [0-9]*) PID=$1 ;;
            *) PID=`pidof $1` ;;
        esac
    
        GPU_USAGE=$(nvidia-smi --query --id=0 --display=UTILIZATION | grep "Gpu" | awk '{ print $3 " %" }')
        CPU_USAGE=$(cpu-usage $1)
        CPU_AFFINITY=$([[ -n $PID ]] && (taskset -pc $PID 2> /dev/null | awk '{ print $6 }')) 
        CPU_AFFINITY=$([[ -z $CPU_AFFINITY ]] && echo "N/A" || echo $CPU_AFFINITY)
        echo "$GPU_USAGE,    $CPU_AFFINITY, $CPU_USAGE"
    done
}

function info() {
    if [[ $(uname) == Darwin ]]; then
        return
    fi
    
    echo "Kernel: $(uname -r)"
    cpu && echo 
    gpu && echo 
    display && echo 
}

function nvmake() {
    MODULE=$1
    ARCH=$2
    BUILD_TYPE=$3
    NVBRANCH=sw/dev/gpu_drv/dev_a

    if [[ -z $P4ROOT ]]; then
        echo "Error: P4ROOT is not configured" > /dev/stderr
        exit 1
    fi

    if [[ -z $NVBRANCH ]]; then
        echo "Error: NVBRANCH is not configured" > /dev/stderr
        exit 1
    fi

    if [[ $(stat -c '%U' $P4ROOT/sw/misc/linux/unix-build) != root ]]; then
        UNIX_BUILD_ARGS="--unshare-namespaces"
    fi

    case $MODULE in
         dev_a) MODULE="drivers dist" ;;
        opengl) exit 1 ;; #TODO
           ppp) MODULE="post-process-packages dist" ;;
         sweep)
            pushd $P4ROOT/$NVBRANCH > /dev/null
            $P4ROOT/sw/misc/linux/unix-build $UNIX_BUILD_ARGS \
                --tools "$P4ROOT/sw/tools" \
                --devrel "$P4ROOT/sw/devrel/SDK/inc/GL" \
                nvmake sweep
            popd > /dev/null 
            return 0
        ;;
        *)
            echo "Error: NVIDIA module $MODULE is not supported" > /dev/stderr
            exit 1
        ;;
    esac

    ERROR=0
    SECONDS=0

    echo "NVMake: linux $MODULE $ARCH $BUILD_TYPE"
    pushd $P4ROOT/$NVBRANCH > /dev/null
    $P4ROOT/sw/misc/linux/unix-build $UNIX_BUILD_ARGS \
    --tools "$P4ROOT/sw/tools" \
    --devrel "$P4ROOT/sw/devrel/SDK/inc/GL" \
    nvmake \
    NV_COLOR_OUTPUT=1 \
    NV_COMPRESS_THREADS=16 \
    NV_FAST_PACKAGE_COMPRESSION=1 \
    NV_EXCLUDE_BUILD_MODULES="" \
    NV_KEEP_UNSTRIPPED_BINARIES=0 \
    NV_GUARDWORD=0 \
    -j16 \
    linux \
    $ARCH \
    $BUILD_TYPE \
    $MODULE \
    1> /tmp/zhujie-nvmake-Linux-$MODULE-$ARCH-$BUILD_TYPE.log \
    2> /tmp/zhujie-nvmake-Linux-$MODULE-$ARCH-$BUILD_TYPE.error && (
        echo "NVMake: $(expr $SECONDS / 60) mins"
        popd > /dev/null 
    ) || (
        grep -E -i -w "fatal|error|errors|critical|failed|: \*\*\*" /tmp/zhujie-nvmake-Linux-$MODULE-$ARCH-$BUILD_TYPE.error;
        popd > /dev/null 
        exit 1
    )
}

function build() {
    if [[ -z $1 ]]; then
        echo "Usage: build <dev_a|opengl|sweep|ppp> [ARCHS...] [TYPES...]" > /dev/stderr
        exit 1
    fi

    ARCHS=""
    BUILD_TYPES=""
    MODULES=""

    while [[ -n $1 ]]; do
        case $1 in
                        amd64|x86) ARCHS="$ARCHS $1" ;;
            debug|release|develop) BUILD_TYPES="$BUILD_TYPES $1" ;;
                     dev_a|opengl) MODULES="$MODULES $1" ;;
                            sweep) nvmake sweep * *; return ;;
                              ppp) nvmake ppp * *; return ;;   
            *)
                echo "Error: unknown argument $1" > /dev/stderr
                build
                exit 1
            ;;
        esac
        shift
    done

    if [[ -z $ARCHS ]]; then
        ARCHS=amd64
    fi

    if [[ -z $BUILD_TYPES ]]; then
        BUILD_TYPES=release
    fi

    for MODULE in $MODULES; do
        for ARCH in $ARCHS; do
            for BUILD_TYPE in $BUILD_TYPES; do
                nvmake "$MODULE" "$ARCH" "$BUILD_TYPE"
            done
        done
    done    
}

function install() {
    if [[ -z $1 ]]; then
        echo "Usage: install [OPTIONS]" > /dev/stderr
        echo "    e.g. install <INSTALLER_PATH>" > /dev/stderr
        echo "    e.g. install <MODULE> <ARCH> <BUILD_TYPE>" > /dev/stderr
        echo "    e.g. install <-r|--revert> <ARCH>" > /dev/stderr
        echo "    e.g. install mesa [version]" > /dev/stderr
        exit 1
    fi

    case $1 in
        opengl)
            MODULE=$1
            shift
            update-nvidia-libs $MODULE "$@"
        ;;
        -r|--revert)
            shift
            revert-nvidia-libs "$@"
        ;;
        mesa)
            sudo add-apt-repository ppa:kisak/kisak-mesa
            sudo apt update
            sudo apt upgrade
            glxinfo | grep "OpenGL renderer string"
            glxinfo | grep Mesa
        ;;
        pts|phoronix-test-suite)
            pushd $HOME/Downloads > /dev/null
            
            if [[ ! -f phoronix-test-suite_10.8.4_all.deb ]]; then
                wget https://phoronix-test-suite.com/releases/repo/pts.debian/files/phoronix-test-suite_10.8.4_all.deb -O $HOME/Downloads/phoronix-test-suite_10.8.4_all.deb
            fi
            
            if [[ -f $HOME/Downloads/phoronix-test-suite_10.8.4_all.deb ]]; then
                chmod 777 $HOME/Downloads/phoronix-test-suite_10.8.4_all.deb 
                sudo apt install -y $HOME/Downloads/phoronix-test-suite_10.8.4_all.deb
            fi
            
            popd > /dev/null
        ;;
        mainline)
            sudo add-apt-repository ppa:cappelikan/ppa
            sudo apt update
            sudo apt install mainline
            which mainline    
        ;;
        gtlfs)
            wget https://gtlfs.nvidia.com/client/linux -O ~/gtlfs
            chmod +x ~/gtlfs
        ;;
        terminus)
            which make > /dev/null || sudo apt install -y build-essential
            wget https://sourceforge.net/projects/terminus-font/files/terminus-font-4.49/terminus-font-4.49.1.tar.gz/download -O $HOME/Downloads/terminus-font-4.49.1.tar.gz
            cd /tmp
            tar -xvf terminus-font-4.49.1.tar.gz
            cd terminus-font-4.49.1
            configure
            make -j8
            sudo make install fontdir
        ;;
        viewperf)
            which p7zip > /dev/null || sudo apt install -y p7zip-full
            
            DOWNLOAD=1
            if [[ -f $HOME/Downloads/SPECviewperf2020v3.0/SPECviewperf2020.ux.3.0.7z ]]; then
                read -p "Do you wanna reuse $HOME/Downloads/SPECviewperf2020v3.0? (empty for Yes): " RSVP
                DOWNLOAD=$([[ -z $RSVP ]] && echo 0 || echo 1)
            fi
            
            if [[ $DOWNLOAD == 1 ]]; then
                read -p "Download from [1] GTL or [2] wsapps02? (empty for 1): " RSVP
                if [[ -z $RSVP || $RSVP == 1 ]]; then
                    cd $HOME/Downloads
                    if [[ -f SPECviewperf2020v3.0.zip ]]; then
                        echo "Reuse cache: $HOME/Downloads/SPECviewperf2020v3.0.zip"
                    else
                        files pull 40651860-8AC9-4C0D-9813-CA80EAF325DE
                    fi
                    unzip -o SPECviewperf2020v3.0.zip
                elif [[ $RSVP == 2 ]]; then
                    mount-windows-folder '\\wsapps02\wsapps02\Benchmarks\SPEC\GPC\ViewPerf' || exit 1
                    rm -r -f $HOME/Downloads/SPECviewperf2020v3.0 
                    cp -r -f /mnt/ViewPerf/Linux/SPECviewperf2020v3.0 $HOME/Downloads/SPECviewperf2020v3.0 
                    umount /mnt/ViewPerf
                    rm -rf /mnt/ViewPerf
                else
                    echo "Error: unexpected argument $RSVP" > /dev/stderr
                    exit 1
                fi
            fi
            
            if [[ -f $HOME/Downloads/SPECviewperf2020v3.0/viewperf2020_3.0_amd64.deb ]]; then
                get-active-display
                echo "Continue in SPECviewperf GUI"
                cd $HOME/Downloads/SPECviewperf2020v3.0
                chmod 777 viewperf2020_3.0_amd64.deb
                sudo apt install viewperf2020_3.0_amd64.deb
            fi
        ;;
        *)
            if [[ -f $1 || -L $1 ]]; then
                run-nvidia-installer "$1"
            else
                echo "Error: $1 doesn't exist" > /dev/stderr
                exit 1
            fi
        ;;
    esac
}

function remove() {
    if [[ -z $1 ]]; then
        echo "Usage: remove [OPTIONS]" > /dev/stderr
        echo "    e.g. remove mesa" > /dev/stderr
        exit 1
    fi

    case $1 in
        mesa)
            sudo apt install ppa-purge
            sudo ppa-purge ppa:kisak/kisak-mesa
            glxinfo | grep "OpenGL renderer string"
            glxinfo | grep Mesa
        ;;
        mainline)
            sudo add-apt-repository --remove ppa:cappelikan/ppa
            sudo apt remove mainline
        ;;
        gtlfs)
            rm -rf ~/gtlfs
        ;;
        *)
            echo "Error: can't remove $1" > /dev/stderr
            exit 1
        ;;
    esac
}

function run-nvidia-installer() {
    INSTALLER=$1
    if [[ -z $INSTALLER ]]; then
        echo "Usage: run-nvidia-installer <INSTALLER_PATH>" > /dev/stderr
        exit 1
    fi

    if [[ ! -f $INSTALLER ]]; then
        echo "Error: NVIDIA installer $INSTALLER doesn't exist" > /dev/stderr
        exit 1
    fi

    sudo chmod +x "$INSTALLER"

    who am i > /dev/null && (
        sudo systemctl isolate multi-user
        sudo "$INSTALLER" -sb
        sudo systemctl isolate graphical
    ) || (
    	echo "Error: can't run NVIDIA installer locally" > /dev/stderr
        exit 1
    )	
}

function revert-nvidia-libs() {
    if [[ -z $1 ]]; then
        echo "Usage: revert-nvidia-libs <ARCH>" > /dev/stderr
        exit 1
    fi

    ARCH=$1 && shift
    ARCHNAME=$([[ $ARCH == amd64 ]] && echo x86_64 || echo i386)
    FOLDER=/usr/lib/$ARCHNAME-linux-gnu

    for FILE in `ls $FOLDER/*.backup`; do
        sudo mv -f "$FILE" "${FILE%.*}"
        echo "Reverted: ${FILE%.*}"
    done
}

function update-nvidia-libs() {
    if [[  -z $1 || -z $2 || -z $3 ]]; then
        echo "Usage: update-nvidia-libs <MODULE> <ARCH> <BUILD_TYPE>" > /dev/stderr
        exit 1
    fi

    MODULE=$1 && shift
    ARCH=$1 && shift
    BUILD_TYPE=$1 && shift 
    FOLDER="Linux_"$ARCH"_$BUILD_TYPE"

    if [[ $(nvidia-source-version) != $(nvidia-version-installed $ARCH) ]]; then  
        echo "Error: NVIDIA modules are version locked can't overwrite *.so.$(nvidia-version-installed $ARCH) with *.so.$(nvidia-source-version)" > /dev/stderr
        exit 1
    fi

    echo "Update NVIDIA module [$MODULE $ARCH $BUILD_TYPE]"
    case $MODULE in
        opengl)
            FOLDER="Linux_"$ARCH"_$BUILD_TYPE"
            OUTDIR=$P4ROOT/$NVBRANCH/drivers/OpenGL/_out/$FOLDER
            BASENAMES=libnvidia-glcore.so

            for BASENAME in $BASENAMES; do
                VERSION=$(nvidia-source-version)
                ARCHNAME=$([[ $ARCH == amd64 ]] && echo x86_64 || echo i386)
                TARGETNAME=/usr/lib/$ARCHNAME-linux-gnu/$BASENAME.$VERSION

                if [[ -f $TARGETNAME || -L $TARGETNAME ]]; then
                    if [[ ! -f $TARGETNAME.backup ]]; then
                        sudo mv $TARGETNAME $TARGETNAME.backup
                    fi
                    sudo cp -f $OUTDIR/$BASENAME $TARGETNAME
                else
                    echo "Error: $TARGETNAME is missing" > /dev/stderr
                    exit 1
                fi

                echo "Updated: $TARGETNAME"
            done
        ;;
        *)
            echo "Error: NVIDIA module $MODULE is not supported" > /dev/stderr
            exit 1
        ;;
    esac 
}

function nvidia-source-version() {
    echo `grep '^#define NV_VERSION_STRING' $P4ROOT/$NVBRANCH/drivers/common/inc/nvUnixVersion.h  | awk '{print $3}' | sed 's/"//g'`
}

function nvidia-version-installed() {
    if [[ -z $1 ]]; then
        echo "Usage: nvidia-version-installed <ARCH>" > /dev/stderr
        exit 1
    fi  

    ARCH=$1
    ARCHNAME=$([[ $ARCH == amd64 ]] && echo x86_64 || echo i386)
    SOFILE=$(ls /usr/lib/$ARCHNAME-linux-gnu/libnvidia-glcore.so* | head -n 1)
    POS=$([[ $ARCH == amd64 ]] && echo 46 || echo 44)
    LEN=$(( ${#SOFILE} - POS ))
    VERSION=${SOFILE:$POS:$LEN}

    if [[ -f /usr/lib/$ARCHNAME-linux-gnu/libnvidia-glvkspirv.so.$VERSION ]]; then
        echo $VERSION
    else
        echo "Error: can't parse NVIDIA version installed" > /dev/stderr
        exit 1
    fi
}

function install-dvs-driver() {
    TYPE=Release
    BRANCH=""
    CL=""   

    while [[ -n $1 ]]; do
        case $1 in
              debug)  TYPE=Debug  ;;
            develop)  TYPE=Develop  ;;
              dev_a)  shift; BRANCH=dev_a; CL=$1 ;;
             public)  shift; BRANCH=public; CL=$1 ;;
            *)
                echo "Error: unknown argument $1" > /dev/stderr
                exit 1
            ;;
        esac
        shift
    done

    case $BRANCH in
        dev_a)
            SUFFIX=$([[ $TYPE == Debug ]] && echo -internal || echo "") 
            URL="http://linuxqa.nvidia.com/dvsbuilds/gpu_drv_dev_a_${TYPE}_Linux_AMD64_unix-build_Test_Driver/SW_$CL.0_gpu_drv_dev_a_${TYPE}_Linux_AMD64_unix-build_Test_Driver.tgz/NVIDIA-Linux-x86_64-DVS${SUFFIX}.run"
            OUT=$HOME/Downloads/NVIDIA-dev_a-$TYPE-CL$CL.run
        ;;
        public)
            PATCH=$([[ $ID == Develop ]] && echo /develop || echo "")
            URL="http://linuxqa/builds/release/display/x86_64${PATCH}/$CL/NVIDIA-Linux-x86_64-$CL.run"
            OUT=$HOME/Downloads/NVIDIA-Public-$TYPE-$CL.run
        ;;
    esac

    echo "Downloading: $OUT"   

    if [[ -f $OUT ]]; then
        echo "Reuse cache: $OUT"
        chmod 777 $OUT
    else
        TMPFILE=/tmp/$(basename $OUT)
        wget $URL -O $TMPFILE && (
            mv -f $TMPFILE $OUT
            chmod 777 $OUT
        ) || (
            echo "Error: can't download $URL" > /dev/stderr
            exit 1
        )
    fi

    if [[ -f $OUT ]]; then
        read -p "Do you wanna install now? (empty for Yes) " RSVP
        case $RSVP in
            yes|y|"")
                echo "Installing $OUT"
                install "$OUT"
            ;;
        esac
    fi
}

function drivers() {
    if [[ -z $1 ]]; then
        echo "Usage: drivers [debug] [develop] [BRANCH CL] [public RELEASE_ID]" > /dev/stderr
        echo "    e.g. drivers dev_a CL" > /dev/stderr
        echo "    e.g. drivers dev_a CL debug" > /dev/stderr
        echo "    e.g. drivers public RELEASE_ID" > /dev/stderr
        echo "    e.g. drivers public RELEASE_ID develop" > /dev/stderr
        exit 1
    fi

    IS_PUBLIC=0
    for VAR in $@; do
        case $VAR in
            public) IS_PUBLIC=1 ;;
        esac
    done

    if [[ ! -f /mnt/linuxqa/nvt.sh || $IS_PUBLIC != 1 ]]; then
        install-dvs-driver "$@"
    else
        /mnt/linuxqa/nvt.sh drivers "$@"
    fi
}

function flamegraph() {    
    which perf || (
        echo "Error: can't find perf in PATH" > /dev/stderr
        exit 1
    )

    NAME=Perf-NoName
    SVG_FILE=$HOME/zhujie-$NAME.svg
    PERF_DATA=$HOME/zhujie-$NAME.data
    PERF_RECORD_SYSTEM_WIDE=1
    PERF_RECORD_PID=" -a "
    PERF_RECORD_SECONDS=10
    PERF_RECORD_ARGS=" -F 100 -g --call-graph dwarf "

    while [[ -n $1 ]]; do
        case $1 in
            -n|--name)
                shift
                NAME=$1
                SVG_FILE=$HOME/zhujie-$NAME.svg
                PERF_DATA=$HOME/zhujie-$NAME.data
            ;;
            -p|--pid)
                shift
                PERF_RECORD_SYSTEM_WIDE=0
                PERF_RECORD_PID=" --pid=$1 "
            ;;
            -s|--sleep)
                shift
                PERF_RECORD_SECONDS=$1
            ;;
            *)
	            if [[ -n $(pidof $1) ]]; then
	                NAME=$([[ $NAME == Perf-NoName ]] && echo $1 || echo $NAME)
	                SVG_FILE=$HOME/zhujie-$NAME.svg
                    PERF_DATA=$HOME/zhujie-$NAME.data
                    PERF_RECORD_SYSTEM_WIDE=0
                    PERF_RECORD_PID=" --pid=$(pidof $NAME) "
	            else
	                echo "Error: process $1 doesn't exist" > /dev/stderr
	                exit 1
	            fi
            ;;
        esac
        shift
    done

    perf --help 1> /dev/null 2> /dev/null || (
        sudo apt install -y linux-tools-`uname -r`
        sudo apt install -y linux-cloud-tools-`uname -r`
        sudo apt install -y linux-tools-generic
        sudo apt install -y linux-cloud-tools-generic
    )

    if [[ -f $PERF_DATA ]]; then
        rm -rf "$PERF_DATA"
    fi

    echo -ne "Running perf record for $PERF_RECORD_SECONDS seconds\t"
    sudo perf record $PERF_RECORD_PID $PERF_RECORD_ARGS \
        --output="$PERF_DATA" \
        --sleep $PERF_RECORD_SECONDS \
        2> /tmp/zhujie-$(basename $PERF_DATA).error \
        && echo "[OK]" || (
            echo "[FAILED]"
            cat /tmp/zhujie-$(basename $PERF_DATA).error
            exit 1
        )
    sudo chmod 777 "$PERF_DATA"

    if [[ ! -f $PERF_DATA ]]; then
        echo "Error: $PERF_DATA is missing" > /dev/stderr
        exit 1
    fi
    
    BASENAME=$(basename "$PERF_DATA")
    
    echo -ne "Running perf script\t"
    sudo perf script --input="$PERF_DATA" \
        1> "/tmp/zhujie-$BASENAME.perf" \
        2> "/tmp/zhujie-$BASENAME.perf.error" \
        && echo "[OK]" || (
            echo "[FAILED]"
            cat "/tmp/zhujie-$BASENAME.perf.error"
            exit 1
        ) 
    
    echo -ne "Running stackcollapse-perf.pl\t"
    sudo stackcollapse-perf.pl "/tmp/zhujie-$BASENAME.perf" \
        1> "/tmp/zhujie-$BASENAME.perf.folded" \
        2> "/tmp/zhujie-$BASENAME.perf.folded.error" \
        && echo "[OK]" || (\
            echo "[FAILED]"
            cat "/tmp/zhujie-$BASENAME.perf.folded.error"
            exit 1
        )
    
    echo -ne "Running stackcollapse-recursive.pl\t"
    sudo stackcollapse-recursive.pl "/tmp/zhujie-$BASENAME.perf.folded" \
        1> "/tmp/zhujie-$BASENAME.perf.folded.recursive" \
        2> "/tmp/zhujie-$BASENAME.perf.folded.recursive.error" \
        && echo "[OK]" || (\
            echo "[FAILED]"
            cat "/tmp/zhujie-$BASENAME.perf.folded.recursive.error"
            exit 1
        )
    
    echo -ne "Running flamegraph.pl\t"
    sudo flamegraph.pl "/tmp/zhujie-$BASENAME.perf.folded.recursive" \
        1> "$SVG_FILE" \
        2> "/tmp/zhujie-$BASENAME.perf.folded.recursive.error" \
        && echo "[OK]" || (\
            echo "[FAILED]"
            cat "/tmp/zhujie-$BASENAME.perf.folded.recursive.error"
            exit 1
        )
}
    
function p4bisect() {
    which p4 || (
        echo "Error: can't find p4 in PATH" > /dev/stderr
        exit 1
    )
    
    if [[ -z $1 || -z $2 || -z $3 ]]; then
        echo "Usage: p4bisect <dev_a|opengl> <DATE_OLD> <DATE_NEW>" > /dev/stderr
        exit 1
    fi
    
    MODULE=$1
    DATE_OLD=$2
    DATE_NEW=$3
    CHANGES="$HOME/zhujie-p4-changes-on-$MODULE"
    
    case $MODULE in
         dev_a) FOLDER="$P4ROOT/sw/dev/gpu_drv/dev_a" ;;
        opengl) FOLDER="$P4ROOT/sw/dev/gpu_drv/dev_a/drivers/OpenGL" ;;
        *)
            echo "Error: NVIDIA module $1 is not supported" > /dev/stderr
            exit 1
        ;;
    esac 
    
    p4 changes -s submitted $FOLDER/...@$DATE_OLD,@$DATE_NEW > $CHANGES
    LINE_COUNT=$(wc -l < $CHANGES)
        
    while [[ $LINE_COUNT > 2 ]]; do
        LINE_NO=$(( $LINE_COUNT/2 ))
        LINE=$(sed -n "${LINE_NO}p" $CHANGES)
    
        IFS=" " read -ra SEGMENTS <<< "$LINE"
        CL="${SEGMENTS[1]}"
        DESC=$(p4 describe -s $CL | head -n 1)
    
        IFS=" " read -ra SEGMENTS <<< "$DESC"
        DATE="${SEGMENTS[5]}:${SEGMENTS[6]}"
        ANSWERED=0
    
        echo "Testing change $CL @$DATE (out of $LINE_COUNT changes):"
    
        read -p "Download from DVS build? (empty for Yes): " RSVP
        case $RSVP in
            yes|y|"") drivers dev_a $CL ;;
        esac
    
        read -p "Is this change new? (empty for Yes): " RSVP 
        case $RSVP in
            yes|y|"") DATE_NEW="$DATE" ;;
            no|n) DATE_OLD="$DATE" ;;
        esac
    
        p4 changes -s submitted $FOLDER/...@$DATE_OLD,@$DATE_NEW > $CHANGES
        LINE_COUNT=$(wc -l < $CHANGES)
        
        echo ""
    done
}
    
function pic-v() {
    which pic-v || (
        echo "Error: can't find pic-v in PATH" > /dev/stderr
        exit 1
    )
    
    if [[ -z $1 ]]; then
        echo "Usage: pic-v [APP]" > /dev/stderr
        exit 1
    fi
    
    # Launch pic-v if it's not running
    pgrep -x pic-v >/dev/null || (
        bash -c "cd $PIC_V && pic-v" &
        sleep 3
    )
    
    # Launch game in current terminal 
    PIC_V_DIR=$(dirname `while pic-v | head -n 1`)
    if [[ ! -f $PIC_V_DIR ]]; then
        echo "Error: can't find pic-v's parent directory" > /dev/stderr
        exit 1
    fi
    
    cd $PIC_V_DIR
    source setup-env.sh
    
    "$@" && (
        # Launch http server if it's not running
        ps aux | grep "[p]ython3 -m http.server" || (
            bash -c "cd $PIC_V/PerfInspector/output && launch-py3-server.sh" &
            sleep 1
        )
    
        URL="http://localhost:8000/"
        which firefox && firefox $URL || ( 
            which chromium && chromium $URL || 
                echo "Open http://localhost:8000/ in your browser" 
        )
    )
}
    
function choose-kernel() {
    echo "Found installed kernel:"
    
    INDEX=-1
    for K in $(find /boot -name vmlinuz-* 2> /dev/null); do
        THISNAME=${K:14:$[${#K}-14]}
        MARK=$([[ $THISNAME == $(uname -r) ]] && echo "*" || echo " ")
        INDEX=$((INDEX+1))
        echo "$MARK [$INDEX]" $THISNAME
    done
    
    read -p "Choose a kernel to be default: " KNAME
    if [[ $KNAME =~ ^[0-9]+$ ]]; then
        INDEX=0
        for K in $(find /boot -name vmlinuz-* 2> /dev/null); do
            if [[ $INDEX == $KNAME ]]; then
                KNAME=${K:14:$[${#K}-14]}
                break
            else
                INDEX=$((INDEX+1))
            fi
        done
    fi
    
    INVALID=1
    for K in $(find /boot -name vmlinuz-* 2> /dev/null); do
        if [[ ${K:14:$[${#K}-14]} == $KNAME ]]; then
            INVALID=0
            break
        fi
    done
    
    if [[ $INVALID == 1 ]]; then
        echo "Error: kernel $KNAME is invalid" > /dev/stderr
        exit 1
    fi
    
    rm -rf /tmp/zhujie-grub.tmp
    while read -r LINE; do
        if [[ $LINE == *"GRUB_DEFAULT"* ]]; then
            echo "GRUB_DEFAULT=\"Advanced options for Ubuntu>Ubuntu, with Linux $KNAME\"" >> "/tmp/zhujie-grub.tmp"
        else
            echo "$LINE" >> /tmp/zhujie-grub.tmp
        fi
    done < /etc/default/grub
    
    sudo cp /tmp/zhujie-grub.tmp /etc/default/grub
    sudo update-grub
}
    
function fake-display() {
    if [[ $EUID != 0 ]]; then
        echo "Error: please run as root" > /dev/stderr
        exit 1
    fi
    
    RESOLUTION=$1
    if [[ $(has-nvidia-gpu) == 1 ]]; then
        if [[ -z $RESOLUTION ]]; then
            echo "Usage: fake-display [RESOLUTION]" > /dev/stderr
            RESOLUTION=$(get-active-resolution --default $_4K)
        fi
    else
        RESOLUTION=""
        echo "Unset NVTEST_DRIVER_DIR for mesa driver"
        unset NVTEST_DRIVER_DIR
    fi
    
    if [[ $(has-nvidia-gpu) == 1 ]]; then
        /mnt/linuxqa/nvt.sh ${RESOLUTION}__runcmd --cmd 'sleep 100000000'
    else
        /mnt/linuxqa/nvt.sh runcmd --cmd 'sleep 100000000'
    fi
}

# Share a running display 
function x0vnc() {
    which x0vncserver > /dev/null || sudo apt install -y tigervnc-scraping-server 

    if [[ -z $VNCPORT ]]; then
        VNCPORT=5900
    fi
    
    if [[ ! -f $HOME/.vnc/passwd ]]; then
        (echo '123456'; echo '123456'; echo 'n') | vncpasswd > /dev/null && (
            echo "VNC password is 123456"
        ) || (
            echo "Error: failed to call vncpasswd" > /dev/stderr
            exit 1
        )
    fi
    
    case $1 in
        status)
            shift
            x0vncserver -list "$@"
        ;;
        stop)
            shift
            x0vncserver -kill "$@"
        ;;
        :[0-9]) 
            SHARED_DISPLAY=$1
            x0vncserver -localhost no -PasswordFile $HOME/.vnc/passwd -rfbport $VNCPORT $SHARED_DISPLAY
        ;;
        *)
            echo "Error: unexpected argument $1" > /dev/stderr
            exit 1
        ;;
    esac
}
    
# Create a virtual display
function vnc() {
    if [[ $1 =~ ^:[0-9]+$ ]]; then
        echo "Switch to x0vnc to share a running display $1"
        x0vnc "$@"
        return
    fi
    
    which vncserver > /dev/null || sudo apt install -y tigervnc-standalone-server 
    
    if [[ -z $VNCPORT ]]; then
        VNCPORT=5900
    fi
    
     if [[ ! -f $HOME/.vnc/passwd ]]; then
        (echo '123456'; echo '123456'; echo 'n') | vncpasswd > /dev/null && (
            echo "VNC password is 123456"
        ) || (
            echo "Error: failed to call vncpasswd" > /dev/stderr
            exit 1
        )
    fi

    case $1 in
        status) 
            shift
            vncserver -list "$@"
        ;;
        stop) 
            shift
            vncserver -kill "$@"
        ;;
        "")
            GEOMETRY=$(get-active-resolution --default $_4K)
            vncserver -localhost no -PasswordFile $HOME/.vnc/passwd -rfbport $VNCPORT -geometry $GEOMETRY
        ;;
        *)
            echo "Error: unexpected argument $1" > /dev/stderr
            exit 1
        ;;
    esac
}
    
function ddnet() {
    # 2560x1440
    # Fullscreen
    # Vulkan
    # Default
    # RaiNyMore2 -- GPU-intensive 

    get-active-display

    (echo 7; echo 2; echo 1; echo 1; echo 2; echo n) | phoronix-test-suite benchmark pts/ddnet
}

function click-talos-message-window() {
    which xdotool > /dev/null || sudo apt install -y xdotool
    sleep 3
    
    VALID=1
    while [[ $VALID == 1 ]]; do
        WINDOW_ID=$(xdotool getactivewindow)
        WINDOW_NAME=$(xdotool getwindowname $WINDOW_ID)
        if [[ $WINDOW_NAME == Message ]]; then
            POSITION=$(xdotool getwindowgeometry $WINDOW_ID | grep Position: | awk '{print $2}')
            EXTENT=$(xdotool getwindowgeometry $WINDOW_ID | grep Geometry: | awk '{print $2}')
            X=${POSITION%,*}; Y=${POSITION#*,}
            W=${EXTENT%x*};   H=${EXTENT#*x}
            xdotool mousemove $((X+W-50)) $((Y+H-70))
            xdotool click 1
        else #elif [[ $WINDOW_NAME == "Talos - Linux - 64bit" ]]; then
            sleep 10
        fi
        
        if [[ -z $(pidof Talos) ]]; then
            VALID=0
        fi
    done
}

function kill-talos-later() {
    sleep 30

    STOP=0
    SECONDS=0
    while [[ $STOP == 0 ]]; do
        if [[ ! -f /tmp/zhujie-talos.log ]]; then
            STOP=1
            continue
        fi

        LINE=$(cat /tmp/zhujie-talos.error | grep "corrupted size vs. prev_size")
        if [[ -n $LINE ]]; then
            pkill -9 Talos 
            STOP=1
            sleep 2
        else
            if [[ -z $(pidof Talos) ]]; then
                STOP=1
            fi
            sleep 2
        fi
    done
}

function talos() {
    get-active-display
    
    DIRECT_CALL=0
    while [[ -n $1 ]]; do
        case $1 in
            -d|--direct) shift; DIRECT_CALL=1 ;;
        esac
        shift
    done
    
    which steam > /dev/null || (
        sudo apt install -y steam
        steam &
        echo "Continue in Steam GUI to log in"
        return 0
    )
    
    pgrep -x steam >/dev/null || (
        steam &
        sleep 20
    )

    if [[ ! -f "$HOME/.steam/steam/steamapps/common/The Talos Principle/Bin/x64/Talos" ]]; then
        echo "Error: install 'Talos Principle' in steam's window and try again" > /dev/stderr
        exit 1
    fi

    click-talos-message-window &
    kill-talos-later &

    RESOLUTION=$(get-active-resolution --default $_2K)
    WIDTH=$(echo $RESOLUTION | awk -F 'x' '{ print $1 }')
    HEIGHT=$(echo $RESOLUTION | awk -F 'x' '{ print $2 }')
    
    if [[ -n $CPU_LIST ]]; then
        read -p "Run with CPU affinity $CPU_LIST? (empty for Yes): " RSVP
        case $RSVP in
            yes|y|"") 
                TASKSET="taskset"
                TASKSET_OPTIONS="--cpu-list"
            ;;
            *) 
                TASKSET=""
                TASKSET_OPTIONS=""
                CPU_LIST=""
                echo "CPU affinity is ignored"
            ;;
        esac 
    else
        TASKSET=""
        TASKSET_OPTIONS=""
    fi
    
    pushd "$HOME/.steam/steam/steamapps/common/The Talos Principle/Bin/x64" > /dev/null
    rm -rf /tmp/zhujie-talos.fps
    $TASKSET $TASKSET_OPTIONS $CPU_LIST ./Talos +gfx_strAPI VLK +gfx_pixResWidth $WIDTH +gfx_pixResHeight $HEIGHT +exec $HOME/.phoronix-test-suite/installed-tests/pts/talos-principle-1.2.1/talos-run-test.lua 1> /tmp/zhujie-talos.log 2> /tmp/zhujie-talos.error 
    popd > /dev/null
    
    FPS=$(cat "/tmp/zhujie-talos.log" | grep "Average:" | tail -n1 | awk '{print $3}')
    if [[ -n $FPS ]]; then
        echo "$FPS :: "
        echo "$FPS" >> /tmp/zhujie-talos.fps
    else
        cat /tmp/zhujie-talos.log
        cat /tmp/zhujie-talos.error
        return 1
    fi
}

function apex() {
    if [[ $EUID != 0 ]]; then
        echo "Error: please run as root" > /dev/stderr
        exit 1
    fi
    
    DIRECT_CALL=0
    while [[ -n $1 ]]; do
        case $1 in
            -d|--direct) DIRECT_CALL=1 ;;
        esac
        shift
    done
    
    if [[ $(has-nvidia-gpu) == 0 ]]; then
        echo "Unset NVTEST_DRIVER_DIR for mesa driver"
        unset NVTEST_DRIVER_DIR
    fi
    
    RESOLUTION=$(get-active-resolution --default $_4K)
    
    if [[ $DIRECT_CALL == 0 ]]; then
        FPS_FILE=$HOME/zhujie-Apex_Legends_Ultra_${RESOLUTION}_1xAA_16xAF.fps
    else
        get-active-display
        FPS_FILE=$HOME/zhujie-Apex_Legends.fps
    fi
    
    if [[ $DIRECT_CALL == 0 ]]; then
        /mnt/linuxqa/nvt.sh DxvkApexLegends --traces Apex_Legends_Ultra_${RESOLUTION}_1xAA_16xAF \
        1> /tmp/zhujie-Apex_Legends_Ultra_${RESOLUTION}_1xAA_16xAF.log \
        2> /tmp/zhujie-Apex_Legends_Ultra_${RESOLUTION}_1xAA_16xAF.error
        
        FPS=$(cat /tmp/zhujie-Apex_Legends_Ultra_${RESOLUTION}_1xAA_16xAF.log | grep -o 'dxvk-v[0-9.]*-fps[[:blank:]]\+[0-9.]*' | awk '{print $2}')
        if [[ -n $FPS ]]; then
            echo "$FPS :: "
            echo "$FPS" >> $FPS_FILE
        else
            cat /tmp/zhujie-Apex_Legends_Ultra_${RESOLUTION}_1xAA_16xAF.log
            cat /tmp/zhujie-Apex_Legends_Ultra_${RESOLUTION}_1xAA_16xAF.error
            return 1
        fi
    else
        if [[ -n $CPU_LIST ]]; then
            read -p "Run with CPU affinity $CPU_LIST? (empty for Yes): " RSVP
            case $RSVP in
                yes|y|"") 
                    TASKSET="taskset"
                    TASKSET_OPTIONS="--cpu-list"
                ;;
                *) 
                    TASKSET=""
                    TASKSET_OPTIONS=""
                    CPU_LIST=""
                    echo "CPU affinity is ignored"
                ;;
            esac 
        else
            TASKSET=""
            TASKSET_OPTIONS=""
        fi
        
        cd /root/nvt/tests/dxvk/run_dir; DISPLAY=:0.0 DXVK_HUD=full DXVK_LOG_LEVEL=none DXVK_STATE_CACHE=0 LD_LIBRARY_PATH=/root/nvt/tests/dxvk/experimental-7.0-20230201/files/lib64:/root/nvt/tests/dxvk/experimental-7.0-20230201/files/lib:/mnt/linuxqa/nvtest/pynv_files/vulkan_loader/sdk-1.1.114/Linux_amd64:/mnt/linuxqa/nvtest/pynv_files/vkdevicechooser/Linux_amd64 LIBC_FATAL_STDERR_=1 NODEVICE_SELECT=1 PATH=/root/nvt/tests/dxvk/experimental-7.0-20230201/files/bin:/root/NVIDIA_TOOLS:/root:/root/bin:/root/.local/bin:/root/NVIDIA_TOOLS:/root:/root/bin:/root/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin PROTON_VR_RUNTIME=1 STEAM_COMPAT_DATA_PATH=/root/nvt/tests/dxvk/experimental-7.0-20230201/prefix VK_ICD_FILENAMES=/etc/vulkan/icd.d/nvidia_icd.json VK_INSTANCE_LAYERS=VK_LAYER_AEJS_DeviceChooserLayer VK_LAYER_PATH=/mnt/linuxqa/nvtest/pynv_files/vulkan_loader/sdk-1.1.114/Linux_amd64/explicit_layer.d:/mnt/linuxqa/nvtest/pynv_files/vkdevicechooser VR_OVERRIDE=1 VULKAN_DEVICE_INDEX=0 WINEDEBUG=-all WINEDLLOVERRIDES='steam.exe=b;d3d11=n;d3d10core=n;dxgi=n;d3d11x_42=n;d3d11x_43=n;d3d9=n;nvcuda=b;' WINEDLLPATH=/root/nvt/tests/dxvk/experimental-7.0-20230201/files/lib64/wine:/root/nvt/tests/dxvk/experimental-7.0-20230201/files/lib/wine WINEESYNC=1 WINEPREFIX=/root/nvt/tests/dxvk/experimental-7.0-20230201/prefix/pfx WINE_MONO_OVERRIDES='Microsoft.Xna.Framework.*,Gac=n' __GL_4718b=0x00000008 __GL_61807119=/root/nvt/log/loadmonitor/00057_run-in-soldier __GL_SHADER_DISK_CACHE=0 __GL_SYNC_TO_VBLANK=0  $TASKSET $TASKSET_OPTIONS $CPU_LIST /root/nvt/tests/dxvk/experimental-7.0-20230201/files/bin/wine /root/nvt/tests/dxvk/run_dir/r5apex.exe 1000 0 fps_log 1> /tmp/zhujie-Apex_Legends.log 2> /tmp/zhujie-Apex_Legends.error 
        
        FPS=$(cat /tmp/zhujie-Apex_Legends.log | grep -o 'average FPS: [0-9.]*' | awk '{print $3}')
        if [[ -n $FPS ]]; then
            echo "$FPS :: "
            echo "$FPS" >> $FPS_FILE
        else
            cat /tmp/zhujie-Apex_Legends.log
            cat /tmp/zhujie-Apex_Legends.error
            return 1
        fi
    fi
}

function get-viewperf-home() {
    if [[ -f $HOME/nvt/tests/viewperf2020v3/viewperf2020/viewperf/bin/viewperf ]]; then
        echo $HOME/nvt/tests/viewperf2020v3/viewperf2020
    elif [[ -f $HOME/viewperf2020/viewperf/bin/viewperf ]]; then
        echo $HOME/viewperf2020
    elif [[ -f /opt/SPEC/SPECviewperf2020/viewperf/bin/viewperf ]]; then
        echo /opt/SPEC/SPECviewperf2020
    else
        echo "NOT-FOUND"
        exit 1
    fi
}

function list-viewperf-resolutions() {
    if [[ $(get-viewperf-home) == NOT-FOUND ]]; then
        echo "Error: can't find viewperf" > /dev/stderr
        exit 1
    fi
    
    if [[ -f $(get-viewperf-home)/viewsets/$1/config/$1.xml ]]; then
        echo "Available resolutions for $1:"
        cat $(get-viewperf-home)/viewsets/$1/config/$1.xml | grep '<Window Resolution=' | awk '{ print $2 }' | awk -F '=' '{ print $2}' | awk -F '"' '{ print $2 }'
    else
        echo "Usage: list-viewperf-resolutions <TEST_NAME>" > /dev/stderr
        exit 1
    fi
}
    
function catia() {
    if [[ $(get-viewperf-home) == NOT-FOUND ]]; then
        echo "Error: can't find viewperf" > /dev/stderr
        exit 1
    fi
    
    get-active-display
    
    if [[ $(has-nvidia-gpu) == 0 ]]; then
        echo "Unset NVTEST_DRIVER_DIR for mesa driver"
        unset NVTEST_DRIVER_DIR
    fi
    
    list-viewperf-resolutions catia
    RESOLUTION=$(get-active-resolution --default $_4K)
    
    if [[ -n $CPU_LIST ]]; then
        read -p "Run with CPU affinity $CPU_LIST? (empty for Yes): " RSVP
        case $RSVP in
            yes|y|"") 
                TASKSET="taskset"
                TASKSET_OPTIONS="--cpu-list"
            ;;
            *) 
                TASKSET=""
                TASKSET_OPTIONS=""
                CPU_LIST=""
                echo "CPU affinity is ignored"
            ;;
        esac 
    else
        TASKSET=""
        TASKSET_OPTIONS=""
    fi
        
    pushd $(get-viewperf-home) > /dev/null
    $TASKSET $TASKSET_OPTIONS $CPU_LIST viewperf/bin/viewperf viewsets/catia/config/catia.xml -resolution $RESOLUTION \
    1> /tmp/zhujie-catia_${RESOLUTION}.log \
    2> /tmp/zhujie-catia_${RESOLUTION}.error 
    popd > /dev/null
    
    FPS=$(cat /tmp/zhujie-catia_${RESOLUTION}.log | grep "<Composite Score=" | grep -o '".*"' | awk '{print substr($0, 2, length($0) - 2)}')
    if [[ -n $FPS ]]; then
        echo "$FPS :: " 
        echo "$FPS" >> $HOME/zhujie-catia_${RESOLUTION}.fps
    else
        cat /tmp/zhujie-catia_${RESOLUTION}.log
        cat /tmp/zhujie-catia_${RESOLUTION}.error
        return 1
    fi
}

function creo() {
    if [[ $(get-viewperf-home) == NOT-FOUND ]]; then
        echo "Error: can't find viewperf" > /dev/stderr
        exit 1
    fi
    
    get-active-display
    
    if [[ $(has-nvidia-gpu) == 0 ]]; then
        echo "Unset NVTEST_DRIVER_DIR for mesa driver"
        unset NVTEST_DRIVER_DIR
    fi
    
    list-viewperf-resolutions creo
    RESOLUTION=$(get-active-resolution --default $_4K)
    
    if [[ -n $CPU_LIST ]]; then
        read -p "Run with CPU affinity $CPU_LIST? (empty for Yes): " RSVP
        case $RSVP in
            yes|y|"") 
                TASKSET="taskset"
                TASKSET_OPTIONS="--cpu-list"
            ;;
            *) 
                TASKSET=""
                TASKSET_OPTIONS=""
                CPU_LIST=""
                echo "CPU affinity is ignored"
            ;;
        esac 
    else
        TASKSET=""
        TASKSET_OPTIONS=""
    fi
        
    pushd $(get-viewperf-home) > /dev/null
    $TASKSET $TASKSET_OPTIONS $CPU_LIST viewperf/bin/viewperf viewsets/creo/config/creo.xml -resolution $RESOLUTION \
    1> /tmp/zhujie-creo_${RESOLUTION}.log \
    2> /tmp/zhujie-creo_${RESOLUTION}.error 
    popd > /dev/null
    
    FPS=$(cat /tmp/zhujie-creo_${RESOLUTION}.log | grep "<Composite Score=" | grep -o '".*"' | awk '{print substr($0, 2, length($0) - 2)}')
    if [[ -n $FPS ]]; then
        echo "$FPS :: "
        echo "$FPS" >> $HOME/zhujie-creo_${RESOLUTION}.fps
    else
        cat /tmp/zhujie-creo_${RESOLUTION}.log
        cat /tmp/zhujie-creo_${RESOLUTION}.error
        return 1
    fi
}

function prime-run() {
    export __NV_PRIME_RENDER_OFFLOAD=1
    export __GLX_VENDOR_LIBRARY_NAME=nvidia
    export __VK_LAYER_NV_optimus=NVIDIA_only
    export VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/nvidia_icd.json
    if [[ ! -f $VK_ICD_FILENAMES ]]; then 
        export VK_ICD_FILENAMES=/etc/vulkan/icd.d/nvidia_icd.json
    fi
    exec "$@"
}

function cpu-count() {
    lscpu | grep "^CPU(s):" | awk '{print $2}'
}

function cpu-offline() {
    if [[ -z $1 ]]; then
        echo "Error: No CPU to put offline" > /dev/stderr
        exit 1
    fi
    
    for RANGE in $@; do
        for i in `seq $(expand-range $RANGE)`; do
            echo 0 | sudo tee /sys/devices/system/cpu/cpu$i/online > /dev/null
        done
    done
}

function cpu-online() {
    for i in `seq 1 $(($(cpu-count) - 1))`; do
        echo 1 | sudo tee /sys/devices/system/cpu/cpu$i/online > /dev/null
    done
}

function cpu-usage() {
    case $1 in
        "") PID="" ;;
        [0-9]*) PID=$1 ;;
        *) PID=$(pidof $1) ;;
    esac
    
    if [[ -n $PID ]]; then
        RANGE=$(expand-range $(taskset -pc $PID | awk '{ print $6 }'))
        for i in `seq $RANGE`; do 
            echo $i > /dev/null
        done
        ps up $PID | awk 'NR==2{ print $3 " %" }' 
    else
        top -bn2 | grep '%Cpu' | tail -1 | grep -P '(....|...) id,'|awk '{print 100-$8 " %"}'
    fi
}

function join-path() {
    PARENT=$1
    CHILD=$2
    if [[ ${PARENT:-1} == '/' ]]; then
        echo "$PARENT$CHILD"
    else
        echo "$PARENT/$CHILD"
    fi
}

function myscp() {
    REMOTE=$1
    PASSWORD=$2
    SRC=$(realpath $3)
    
    if [[ -z $REMOTE || -z $PASSWORD || -z $SRC ]]; then
        echo "Usage: myscp <USER@IP> <PASSWORD> <PATH>" > /dev/stderr
        exit 1
    fi
    
    if [[ -d $SRC ]]; then
        cd $SRC
        for CHILD in `ls .`; do
            SRC=$(join-path $(pwd) $CHILD)
            myscp $REMOTE $PASSWORD $SRC
        done
        cd ..
    else
        if [[ $SRC =~ "/Users/"* ]]; then
            DST=$REMOTE:'/home/'${SRC:7}
        else
            DST=$REMOTE:$SRC
        fi
        
        echo $PASSWORD | scp $SRC $DST
    fi
}

function sync-on-LAN() {
    REMOTE=$1; shift 
    FILES="$@"
    
    if [[ -z REMOTE || -z FILES ]]; then
        echo "Usage: sync-on-LAN <USER@IP> <FILES...>" > /dev/stderr
        exit 1
    fi
    
    for SRC in $FILES; do
        DST=$(dirname $SRC)
        if [[ $DST =~ "/Users/"* ]]; then
            DST='/home/'${DST:7}
        fi
        
        scp -r $SRC $REMOTE:$DST
    done
}

function validate-ip() {
    RX='([1-9]?[0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])'
    if [[ $1 =~ ^$RX\.$RX\.$RX\.$RX$ ]]; then
      echo 1
   else
      echo 0
   fi
}

function sync-zhujie() {
    if [[ $(validate-ip $1) == 1 ]]; then
        REMOTE=$1
        sync-on-LAN $REMOTE $HOME/zhujie/ 
        return
    fi
    
    if [[ $1 == 1 ]]; then
        NO_PUSH=1
    fi
    
    USE_TMP_GIT=0
    BASEDIR=$(dirname $0)
    if [[ ! -d $BASEDIR/.git ]]; then
        read -p "Force update/overwrite $0? (empty for Yes): " RSVP
        case $RSVP in
            yes|y|"") USE_TMP_GIT=1 ;;
            *) echo "Nothing updated"; exit 1 ;;
        esac
    fi
    
    if [[ $USE_TMP_GIT == 1 ]]; then
        if [[ ! -d /tmp/zhujie ]]; then 
            git clone https://github.com/wanlizhu/zhujie /tmp/zhujie
        fi 
        
        pushd /tmp/zhujie > /dev/null
        cp -f $0 /tmp/zhujie/zhujie
        git add .
        git commit -m "$(date)"
        git pull
        if [[ -z $NO_PUSH ]]; then
            git push --set-upstream https://github.com/wanlizhu/zhujie master
        fi
        cp -f /tmp/zhujie/zhujie $0
        popd > /dev/null
    else
        pushd "$BASEDIR" > /dev/null
        git add .
        git commit -m "$(date)"
        git pull
        if [[ -z $NO_PUSH ]]; then
            git push --set-upstream https://github.com/wanlizhu/zhujie master
        fi
        popd > /dev/null
    fi
}

function sync() {
    sync-zhujie "$@"
}

function vpn() {
    which openconnect > /dev/null || sudo apt install -y openconnect
    
    if [[ $1 == off ]]; then
        sudo pkill -9 `pidof openconnect` 
        return
    fi
    
    if [[ -z $1 ]]; then
        read -p "DUO pass code: " CODE
    else
        CODE=$1
    fi
    
    which openconnect || (
        echo "Error: can't find openconnect in PATH" > /dev/stderr
        exit 1
    )
    
    echo "Xavier#35224047,$CODE" | sudo openconnect --authgroup Employee -u wanliz https://ngvpn32.vpn.nvidia.com:8443
}

function mean() {
    INLINE=False
    FILE=""
    
    while [[ -n $1 ]]; do
        case $1 in
            --inline) INLINE=True ;;
            *) FILE=$1 ;;
        esac
        shift
    done
    
    if [[ ! -f $FILE ]]; then
        echo "Error: $FILE doesn't exist" > /dev/stderr
        exit 1
    fi
    
    python3 -c "
import statistics as stat
columns = []
labels = []
lines_count = 0
with open(\"$FILE\", \"r\") as file:
    for line in [ line.strip() for line in file.readlines() ]:
        lines_count += 1
        NW = -1
        for word in [ word.strip() for word in line.split(',') ]:
            NW += 1
            if len(columns) == 0:
                columns = [ [] for x in line.split(',') ]
                labels = [ 'FPS' for x in columns ]
            if word.replace('.', '0').replace('-', '0').isdigit():
                columns[NW].append(float(word))
            else:
                labels[NW] = word
try:
    if lines_count >= 2:
        for i in range(0, len(columns)):
            if $INLINE:
                print('{:.4f}'.format(stat.mean(columns[i])))
            else:
                print('{}: {:.4f}'.format(labels[i], stat.mean(columns[i])))
except:
    print('N/A')
"
}

function mean2() {
    INLINE=False
    FILE=""
    
    while [[ -n $1 ]]; do
        case $1 in
            --inline) INLINE=True ;;
            *) FILE=$1 ;;
        esac
        shift
    done
    
    if [[ ! -f $FILE ]]; then
        echo "Error: $FILE doesn't exist" > /dev/stderr
        exit 1
    fi
    
    python3 -c "
import statistics as stat
columns = []
labels = []
lines_count = 0
has_label_line = False
with open(\"$FILE\", \"r\") as file:
    for line in [ line.strip() for line in file.readlines() ]:
        lines_count += 1
        NW = -1
        for word in [ word.strip() for word in line.split(',') ]:
            NW += 1
            if len(columns) == 0:
                columns = [ [] for x in line.split(',') ]
                labels = [ 'FPS' for x in columns ]
            if word.replace('.', '0').replace('-', '0').isdigit():
                columns[NW].append(float(word))
            else:
                labels[NW] = word
                has_label_line = True
try:
    if lines_count >= 2 + (1 if has_label_line else 0):
        if $INLINE:
            numbers = [ '{:.4f}'.format(stat.mean(column)) for column in columns ]
            print(','.join(numbers))
        else:
            for i in range(0, len(columns)):
                print('{}: {:.4f} (StdDev: {:.4f})'.format(labels[i], stat.mean(columns[i]), stat.stdev(columns[i])))
except:
    print('N/A')
"
}

function average() {
    mean2 "$@"
}

function validate-range() {
    return 0
}

function expand-range() {
    if [[ $1 == *"-"* ]]; then
        echo "${1/-/ }"
    else
        echo "$1 $1"
    fi
}

function visualize() {
    INFILE=""
    TITLE=""
    XLABEL=""
    YLABEL=""
    
    while [[ -n $1 ]]; do
        case $1 in
             -i|--input) shift; INFILE=$1 ;;
             -t|--title) shift; TITLE=$1 ;;
            -x|--xlabel) shift; XLABEL=$1 ;;
            -y|--ylabel) shift; YLABEL=$1 ;;
            *)
                if [[ -f $1 ]]; then
                    INFILE=$1
                fi
            ;;
        esac
        shift
    done
    
    if [[ ! -f $INFILE ]]; then
        echo "Usage: visualize -i <INFILE> -t <TITLE> -x <XLABEL> -y <YLABEL>" > /dev/stderr
        exit 1
    fi
    
    if [[ -z $TITLE ]]; then
        TITLE=$(basename $INFILE)
    fi
    
    if [[ -z $XLABEL ]]; then
        XLABEL="Test Index"
    fi
    
    if [[ -z $YLABEL ]]; then
        YLABEL="Average FPS"
    fi
    
    python3 -c "
from signal import signal, SIGINT
from sys import exit
import subprocess as subproc
try:
    import matplotlib
    import numpy
except ImportError:
    subproc.run('python3 -m pip install matplotlib', shell=True, check=True)
    subproc.run('python3 -m pip install numpy', shell=True, check=True)
import matplotlib
import matplotlib.pyplot as plt
import numpy as np
import statistics as stat

def sigint_proc(signal_received, frame):
    print('SIGINT or CTRL-C detected')
    exit(0)

signal(SIGINT, sigint_proc)

def viz_polyline(values):
    values=np.array(values)
    pos=np.array(list(range(1, len(values)+1)))
    ymax=values.max()
    ymin=values.min()
    xmax=pos[np.argmax(values)]
    xmin=pos[np.argmin(values)]
    delta=(values.max() - values.min()) / 15.0
    plt.suptitle(\"$TITLE\")
    plt.title('Mean: {}, StdDev: {:.4f}'.format(stat.mean(values), stat.stdev(values), fontweight='bold'), fontweight='bold')
    plt.xlabel(\"$XLABEL\", fontweight='bold')
    plt.ylabel(\"$YLABEL\", fontweight='bold')
    plt.xticks(np.arange(pos.min(), pos.max(), 1))
    plt.yticks(np.arange(values.min(), values.max(), delta))
    plt.plot(pos, values, color='blue')
    plt.annotate('Max: {}'.format(ymax), xy=(xmax, ymax), xytext=(xmax, ymax))
    plt.annotate('Min: {}'.format(ymin), xy=(xmin, ymin), xytext=(xmin, ymin))
    plt.savefig(\"$INFILE.png\")
    plt.show()

def viz_polylines(values_list):
    if len(values_list) == 1:
        viz_polyline(values_list[0])
    else:
        for V in values_list:
            print(V)
    
values_list = []
with open(\"$INFILE\") as file:
    lines = file.readlines()
    for j in range(0, len(lines)):
        words = lines[j].strip().split(',')
        if not values_list:
            values_list = [[] for x in words]
            try:
                _ = float(words[0])
            except:
                continue
        for i in range(0, len(words)):
            values_list[i].append(float(words[i]))
            
viz_polylines(values_list)
"
}

function randoms() {
    if [[ -z $1 ]]; then
        echo "Usage: randoms <COUNT> <MIN> <MAX>" > /dev/stderr
        exit 1
    fi
    
    COUNT=$1
    MIN=$([[ -z $2 ]] && echo 0 || echo $2)
    MAX=$([[ -z $3 ]] && echo 100 || echo $3)
    NUMBERS=""
    
    for i in `seq 1 $COUNT`; do
        NUM=$(($MIN + $RANDOM % $MAX))
        if [[ -z $NUMBERS ]]; then
            NUMBERS=$NUM
        else
            NUMBERS="$NUMBERS $NUM"
        fi
    done
    
    echo $NUMBERS
}

function image() {
    if [[ -z $1 ]]; then
        echo "Usage: image <SUBCMD> [FILE...]" > /dev/stderr
        exit 1
    fi

    case $1 in
        combine)
            shift
            combine-images "$@"
        ;;
    esac
}

function combine-images() {
    FILES=""
    VERTICAL=0

    while [[ -n $1 ]]; do
        case $1 in
              -v|--vertical) VERTICAL=1 ;;
            -h|--horizontal) VERTICAL=0 ;;
            *)
                if [[ -z $FILES ]]; then
                    FILES="\"$1\""
                else
                    FILES="$FILES, \"$1\""
                fi
            ;;
        esac
        shift
    done

    python3 -c "
import sys
import subprocess as subproc
try:
    from PIL import Image
except:
    subproc.run('python3 -m pip install PIL', shell=True, check=True)
from PIL import Image

images = [Image.open(x) for x in [$FILES]]
widths, heights = zip(*(img.size for img in images))

if \"$VERTICAL\" == \"1\":
    sum_height = sum(heights)
    max_width = max(widths)
    new_image = Image.new('RGB', (max_width, sum_height))
    
    y_offset = 0
    for image in images:
        new_image.paste(image, (0, y_offset))
        y_offset += image.size[1]
else:
    sum_width = sum(widths)
    max_height = max(heights)
    new_image = Image.new('RGB', (sum_width, max_height))
    
    x_offset = 0
    for image in images:
        new_image.paste(image, (x_offset, 0))
        x_offset += image.size[0]

new_image.save('combined-image.jpg')
"
}

function check-ssh() {
    if [[ -z $1 ]]; then
        echo "Usage: check-ssh <IP>" > /dev/stderr
        exit 1
    fi
    
    which nmap > /dev/null || sudo apt install -y nmap
    nmap $1 -Pn -p ssh | egrep -io 'open|closed|filtered'
}

function get-mac-ip() {
    if [[ -f /tmp/zhujie-mac-ip ]]; then
        MAC_IP=$(cat /tmp/zhujie-mac-ip)
        if [[ $(check-ssh $MAC_IP) == open ]]; then
            echo $MAC_IP && return
        else
            echo "SSH server ($MAC_IP:22) is not available"
        fi
    fi
}

function ip() {
     ifconfig | grep "inet " | awk '{print $2}' | sort
}

function z() {
    zhujie "$@"
}

function files() {
    which gtlfs > /dev/null || (
        sudo wget https://gtlfs.nvidia.com/client/linux -O /usr/local/bin/gtlfs &&
        sudo chmod +x /usr/local/bin/gtlfs
    )
    
    which gtlfs > /dev/null || (
        echo "Error: can't find gtlfs in PATH" > /dev/stderr
        exit 1
    )
    
    if [[ -z $1 || -z $2 ]]; then
        echo "Usage: files <SUBCMD> <FILES...>" > /dev/stderr
        exit 1
    fi
    
    if [[ -f /tmp/zhujie-gtlfs-password-cache ]]; then
        PASSWD=$(cat /tmp/zhujie-gtlfs-password-cache)
    else
        read -p "GTLFS Password: " PASSWD
        echo $PASSWD > /tmp/zhujie-gtlfs-password-cache
    fi
    
    case $1 in 
        push|up)
            shift
            gtlfs push --username=wanliz --password=$PASSWD "$@"
        ;;
        pull|down)
            shift
            gtlfs pull --username=wanliz --password=$PASSWD "$@"
        ;;
        rm|remove)
            shift
            gtlfs rm --username=wanliz --password=$PASSWD "$@"
        ;;
        pull-rm|pop)
            shift
            gtlfs pull --username=wanliz --password=$PASSWD "$@" && (
                read -p "Remove it from server? (empty for Yes)" RSVP
                case $RSVP in
                    yes|y|"")
                        echo y | gtlfs rm --username=wanliz --password=$PASSWD "$@"
                    ;;
                    *)
                        echo "Nothing removed"
                    ;;
                esac
            )
        ;;
        *)
            echo "Error: unknown argument $1" > /dev/stderr
            exit 1
        ;;
    esac
}

function get-active-resolution() {
    DEFAULT=""
    while [[ -n $1 ]]; do
        case $1 in
            -d|--default) shift; DEFAULT=$1 ;;
        esac
        shift
    done
    
    RESOLUTION=""
    if [[ -f /tmp/zhujie-active-resolution ]]; then
        RESOLUTION=$(cat /tmp/zhujie-active-resolution)
    fi
    
    if [[ -z $RESOLUTION ]]; then
        if [[ -n $DEFAULT ]]; then
            read -p "Name a resolution to continue (empty for $DEFAULT): " RSVP
            case $RSVP in
                "") RESOLUTION=$DEFAULT ;;
                 *) RESOLUTION=$RSVP ;;
            esac
        fi
    fi
    
    case $RESOLUTION in
        1080p|1080P|1920|1080) RESOLUTION=$_1080P ;;
        1k|1K|1280|1024) RESOLUTION=$_1K ;;
        2k|2K|2560|1440) RESOLUTION=$_2K ;;
        4k|4K|3840|2160) RESOLUTION=$_4K ;; 
    esac
    
    echo $RESOLUTION | tee /tmp/zhujie-active-resolution
}

function lock-cpu-clock() {
    NEW_CLOCK=$1
    if [[ $(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_setspeed) == "<unsupported>" ]]; then
        SCALING_SETSPEED_SUPPORTED=0
        NEW_CLOCK=""
    else 
        SCALING_SETSPEED_SUPPORTED=1
    fi
    
    if [[ -f $HOME/zhujie-lock-cpu-clock-backups ]]; then 
        echo "Error: $HOME/zhujie-lock-cpu-clock-backups already exists" > /dev/stderr
        exit 1
    fi
    
    if [[ $NEW_CLOCK == 0 ]]; then
        echo "Keep current CPU clock"
        return 0
    fi
    
    CPU_CORES=$(lscpu | grep "On-line CPU(s) list:" | awk '{ print $4 }')
    
    for INDEX in `seq $(expand-range $CPU_CORES)`; do
        if [[ $SCALING_SETSPEED_SUPPORTED == 1 ]]; then
            MIN_FREQ=$(cat /sys/devices/system/cpu/cpu$INDEX/cpufreq/cpuinfo_min_freq)
            if [[ $NEW_CLOCK < $MIN_FREQ ]]; then
                NEW_CLOCK=$MIN_FREQ
            fi
            
            MAX_FREQ=$(cat /sys/devices/system/cpu/cpu$INDEX/cpufreq/cpuinfo_max_freq)
            if [[ $NEW_CLOCK > $MAX_FREQ ]]; then
                NEW_CLOCK=$MAX_FREQ
            fi
        
            SCALING_MIN_SETSPEED=$(cat /sys/devices/system/cpu/cpu$INDEX/cpufreq/scaling_setspeed)
            echo "$INDEX scaling_setspeed $SCALING_SETSPEED" >> $HOME/zhujie-lock-cpu-clock-backups
            echo $NEW_CLOCK | sudo tee /sys/devices/system/cpu/cpu$INDEX/cpufreq/scaling_setspeed > /dev/null
        fi
        
        BASE_CLOCK=$(cat /sys/devices/system/cpu/cpu$INDEX/cpufreq/base_frequency)
        
        SCALING_MAX_FREQ=$(cat /sys/devices/system/cpu/cpu$INDEX/cpufreq/scaling_max_freq)
        echo "$INDEX scaling_max_freq $SCALING_MAX_FREQ" >> $HOME/zhujie-lock-cpu-clock-backups
        echo $BASE_CLOCK | sudo tee /sys/devices/system/cpu/cpu$INDEX/cpufreq/scaling_max_freq > /dev/null
        
        SCALING_MIN_FREQ=$(cat /sys/devices/system/cpu/cpu$INDEX/cpufreq/scaling_min_freq)
        echo "$INDEX scaling_min_freq $SCALING_MIN_FREQ" >> $HOME/zhujie-lock-cpu-clock-backups
        echo $BASE_CLOCK | sudo tee /sys/devices/system/cpu/cpu$INDEX/cpufreq/scaling_min_freq > /dev/null
            
        SCALING_GOVERNOR=$(cat /sys/devices/system/cpu/cpu$INDEX/cpufreq/scaling_governor)
        echo "$INDEX scaling_governor $SCALING_GOVERNOR" >> $HOME/zhujie-lock-cpu-clock-backups
        echo "performance" | sudo tee /sys/devices/system/cpu/cpu$INDEX/cpufreq/scaling_governor > /dev/null
        
        NO_TURBO=$(cat /sys/devices/system/cpu/intel_pstate/no_turbo)
        echo "$NO_TURBO" > $HOME/zhujie-no_turbo-backup
        echo "1" | sudo tee /sys/devices/system/cpu/intel_pstate/no_turbo > /dev/null
    done
    
    echo "Lock CPU clock"
}

function unlock-cpu-clock() {
    if [[ ! -f $HOME/zhujie-lock-cpu-clock-backups ]]; then 
        return 0
    fi
    
    while read -r LINE; do
        IFS=" " read -a WORDS <<< "$LINE"
        if [[ -n ${WORDS[0]} && -n ${WORDS[1]} && -n ${WORDS[2]} ]]; then
            echo ${WORDS[2]} | sudo tee /sys/devices/system/cpu/cpu${WORDS[0]}/cpufreq/${WORDS[1]} > /dev/null
        fi
    done < $HOME/zhujie-lock-cpu-clock-backups
    rm -rf $HOME/zhujie-lock-cpu-clock-backups
    
    if [[ -f $HOME/zhujie-no_turbo-backup ]]; then
        echo "$(cat $HOME/zhujie-no_turbo-backup)" | sudo tee /sys/devices/system/cpu/intel_pstate/no_turbo > /dev/null
        rm -rf $HOME/zhujie-no_turbo-backup
    fi
    
    echo "Unlock CPU clock"
}

function show-cpu-clock() {
    echo "$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq) KHz"
}

function lock-gpu-clock() {
    echo "Lock GPU clock"
}

function unlock-gpu-clock() {
    echo "Unlock GPU clock"
}

function show-gpu-clock() {
    echo 0
}

function average-fps() {
    RESOLUTION=""
    LOOPS=1
    SUFFIX=""
    
    while [[ -n $1 ]]; do
        case $1 in
               # -c|--cpu-clock) shift; CPU_CLOCK=$1; SUFFIX="$SUFFIX-cpu-clock-$1" ;;
               # -g|--gpu-clock) shift; GPU_CLOCK=$1; SUFFIX="$SUFFIX-gpu-clock-$1" ;;
             -r|--resolution) shift; RESOLUTION=$1; SUFFIX="$SUFFIX-$1" ;;
                   -l|--loop) shift; LOOPS=$1; SUFFIX="$SUFFIX-loop-$1" ;;
                           *) break ;;
        esac
        shift
    done
    
    SUFFIX="-$1$SUFFIX"
    
    lock-cpu-clock 
    lock-gpu-clock 
    echo $RESOLUTION > /tmp/zhujie-active-resolution
    
    rm -rf /tmp/zhujie-average-fps$SUFFIX

    for i in `seq 1 $LOOPS`; do
        echo "Running $i out of $LOOPS iterations ..."
        echo "$@"
        
        "$@" 1>/tmp/zhujie-$1.log 2>/tmp/zhujie-$1.error && (
            cat /tmp/zhujie-$1.log | grep "::" | awk -F '::' '{ print $1 }' | tee -a /tmp/zhujie-average-fps$SUFFIX
        ) || (
            cat /tmp/zhujie-$1.log
            cat /tmp/zhujie-$1.error
        )
    done
    
    echo "$(average /tmp/zhujie-average-fps$SUFFIX)    :: CPU Clock: $(show-cpu-clock), GPU Clock: $(show-gpu-clock), Resolution: $RESOLUTION"
    
    rm -rf /tmp/zhujie-active-resolution
    unlock-gpu-clock
    unlock-cpu-clock 
}

function is-cpu-limited() {
    LOOS=1
    
    FPS_RESOLUTION_1K=$(average-fps --loop $LOOPS --resolution ${_1K} "$@" | awk '{ print $1 }')
    FPS_RESOLUTION_2K=$(average-fps --loop $LOOPS --resolution ${_2K} "$@" | awk '{ print $1 }')
    FPS_RESOLUTION_4K=$(average-fps --loop $LOOPS --resolution ${_4K} "$@" | awk '{ print $1 }')
    
    echo "Target Application: $1"
    echo "FPS @ $_1K: $FPS_RESOLUTION_1K"
    echo "FPS @ $_2K: $FPS_RESOLUTION_2K"
    echo "FPS @ $_3K: $FPS_RESOLUTION_4K"
    echo ""
}

function config-htop() {
    if [[ $1 == save ]]; then
        cp $HOME/.config/htop/htoprc $(dirname $0)
        echo "Saved to $(dirname $0)/htoprc"
    else
        if [[ -f $(dirname $0)/htoprc ]]; then
            cp -f $(dirname $0)/htoprc $HOME/.config/htop/htoprc && (
                echo "Updated $HOME/.config/htop/htoprc"
            )
        else
            echo "Template doesn't exist" > /dev/stderr
        fi
    fi
}

function config-ssh() {
    mkdir -p $HOME/.ssh
    
    # On the client side
    if [[ $(! test -f $HOME/.ssh/config) || -z $(cat $HOME/.ssh/config | grep '[[:blank:]]ForwardX11[[:blank:]]yes') ]]; then
        echo "ForwardX11 yes" >> $HOME/.ssh/config
    fi
    
    # On the server side
    if [[ -z $(cat /etc/ssh/sshd_config | grep '[[:blank:]]X11Forwarding[[:blank:]]yes') ]]; then
        echo 'X11Forwarding yes' | sudo tee -a /etc/ssh/sshd_config > /dev/null
    fi
}

function reboot-and-run() {
    echo TODO
}

function mount-windows-folder() {
    which mount.cifs > /dev/null || sudo apt install -y cifs-utils
    
    while [[ -n $1 ]]; do
        case $1 in
            -n|--name) shift; NAME=$1 ;;
            *) URL=$1 ;;
        esac
        shift
    done
    
    if [[ -z $URL ]]; then
        echo "Usage: mount-windows-folder <URL> [--name NAME]" > /dev/stderr
        exit 1
    else
        URL="${URL//\\/\/}"
    fi
    
    if [[ -z $NAME ]]; then
        NAME=$(basename "$URL")
        NAME="${NAME//[^[:alnum:]]/_}"
    fi
    
    if [[ -d /mnt/$NAME ]]; then
        read -p "Mount point exists, reuse /mnt/$NAME? (empty for Yes): " RSVP
        case $RSVP in
            yes|y|"") ;;
            *) echo "Cancelled"; exit 1 ;;
        esac
    else
        sudo mkdir /mnt/$NAME
    fi
    
    sudo mount -o ro,username=wanliz "$URL" /mnt/$NAME || exit 1
}

function ssh-key() {
    echo TODO
}

function build-kernel() {
    sudo apt install -y git fakeroot build-essential ncurses-dev xz-utils libssl-dev bc flex libelf-dev bison dwarves
    cp -v /boot/config-$(uname -r) .config
    scripts/config --disable SYSTEM_TRUSTED_KEYS
    scripts/config --disable SYSTEM_REVOCATION_KEYS
    make -j$(($(nproc) - 2)) && sudo make modules_install && sudo make install
}

function test() {
    for i in `seq 1 20`; do
        cpu-online
        cpu-offline $(randoms 8 1 23)
        talos >> talos-disable-random-8-cores.log
    done
    cpu-online 
}








case $1 in
    help)
        echo "Usage: zhujie <SUBCMD>" > /dev/stderr
        exit 1
    ;;
    ip)
        shift
        ip "$@"
    ;;
    sync)
        shift
        sync "$@"
    ;;
    build)
        shift
        build "$@"
    ;;
    install)
        shift
        install "$@"  
    ;;
    rm|remove)
        shift
        remove "$@"
    ;;
    ddnet)
        shift
        ddnet "$@"
    ;;
    talos)
        shift
        talos "$@"
    ;;
    drv|drivers)
        shift
        drivers "$@"
    ;;
    flgf|flamegraph)
        shift
        flamegraph "$@"
    ;;
    info)
        shift
        info "$@"
    ;;
    p4bisect)
        shift
        p4bisect "$@"
    ;;
    pic-v)
        shift
        pic-v "$@"
    ;;
    vpn)
        shift
        vpn "$@"
    ;;
    prime-run)
        shift
        prime-run "$@"
    ;;
    cskn|choose-kernel)
        shift
        choose-kernel "$@"
    ;;
    mean)
        shift
        mean "$@"
    ;;
    mean2)
        shift
        mean2 "$@"
    ;;
    avg|average)
        shift
        average "$@"
    ;;
    fkdp|fake-display)
        shift
        fake-display "$@"
    ;;
    vnc)
        shift
        vnc "$@"
    ;;
    x0vnc)
        shift
        x0vnc "$@"
    ;;
    apex)
        shift
        apex "$@"
    ;;
    catia)
        shift
        catia "$@"
    ;;
    creo)
        shift
        creo "$@"
    ;;
    dp|display)
        shift
        display "$@"
    ;;
    average-fps)
        shift
        average-fps "$@"
    ;;
    cpu-offline)
        shift
        cpu-offline "$@"
    ;;
    cpu-online)
        shift
        cpu-online "$@"
    ;;
    cpu)
        shift
        cpu "$@"
    ;;
    gpu)
        shift
        gpu "$@"
    ;;
    perf)
        shift
        perf "$@"
    ;;
    viz|visualize)
        shift
        visualize "$@"
    ;;
    img|image)
        shift
        image "$@"
    ;;
    fs|files)
        shift
        files "$@"
    ;;
    pull)
        shift
        files pull "$@"
    ;;
    push)
        shift
        files push "$@"
    ;;
    fetch)
        shift
        files pull-rm "$@"
    ;;
    is-cpu-limited)
        shift
        is-cpu-limited "$@"
    ;;
    config-ssh)
        shift
        config-ssh "$@"
    ;;
    config-htop)
        shift
        config-htop "$@"
    ;;
    reboot-and-run)
        shift
        reboot-and-run "$@"
    ;;
    mount-windows-folder)
        shift
        mount-windows-folder "$@"
    ;;
    ssh-key)
        shift
        ssh-key "$@"
    ;;
    build-kernel)
        shift
        build-kernel "$@"
    ;;
    test)
        shift
        test "$@"
    ;;
esac
