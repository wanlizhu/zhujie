#!/bin/bash
DVSBUILD_DOWNLOADS="$HOME/NVIDIA/DVSBuild-Downloads"
mkdir -p "$DVSBUILD_DOWNLOADS"

function dvsbuild-download() {
    URL=""
    OUT=""
    INSTALL=0
    
    while [ -n "$1" ]; do
        case "$1" in
            -i|--install)
                INSTALL=1
            ;;
            
            dev_a)
                shift
                CL="$1"
                TYPE="RELEASE"
                URL_PATCH="Release"
                URL_PATCH2=""
                if [[ $CL == *":dbg"* ]]; then
                    TYPE="DEBUG"
                    URL_PATCH="Debug"
                    URL_PATCH2="-internal"
                fi
                CL="${CL%:*}"
                URL="http://linuxqa.nvidia.com/dvsbuilds/gpu_drv_dev_a_${URL_PATCH}_Linux_AMD64_unix-build_Test_Driver/SW_$CL.0_gpu_drv_dev_a_${URL_PATCH}_Linux_AMD64_unix-build_Test_Driver.tgz/NVIDIA-Linux-x86_64-DVS${URL_PATCH2}.run"
                OUT="$DVSBUILD_DOWNLOADS/NVIDIA-DEV_A-$TYPE-$CL.run"
                echo "Downloading: $OUT"
            ;;
            
            release)
                shift
                ID="$1"
                TYPE="RELEASE"
                URL_PATCH=""
                if [[ $ID == *":dev"* ]]; then
                    TYPE="DEVELOP"
                    URL_PATCH="/develop"
                fi
                ID="${ID%:*}"
                URL="http://linuxqa/builds/release/display/x86_64${URL_PATCH}/$ID/NVIDIA-Linux-x86_64-$ID.run"
                OUT="$DVSBUILD_DOWNLOADS/NVIDIA-$TYPE-$ID.run"
                echo "Downloading: $OUT"
            ;;
        esac
        shift
    done
    
    if [ "$URL" = "" -o "$OUT" = "" ]; then
        dvsbuild # Show usage
        exit 1
    fi
    
    if [ -f "$OUT" ]; then
        echo "Reuse cache: $OUT"
        chmod 777 "$OUT" 
    else
        wget $URL -O "$OUT" && (
            chmod 777 "$OUT" 
            ln -s -f "$OUT" "$DVSBUILD_DOWNLOADS/LAST_DOWNLOAD"
        ) || (
            INSTALL=0
        )
    fi
    
    if [ "$INSTALL" = "1" ]; then
        nvidia-install "$OUT"
    fi
}

## MAIN

if [ -z "$1" ]; then
    echo "Usage: dvsbuild [download [dev_a CL] [release ID[:dev]] [-i]]"
    echo "  e.g. dvsbuild download dev_a CL"
    echo "  e.g. dvsbuild download release ID"
    echo "  e.g. dvsbuild download release ID:dev"
    exit 1
fi

while [ -n "$1" ]; do
    case "$1" in
        download)
            shift
            dvsbuild-download $@
            exit 0
        ;;
        
        *)
        echo "Error: Unknown command: $1" > /dev/stderr
	dvsbuild
        exit 1
    esac
    shift
done


